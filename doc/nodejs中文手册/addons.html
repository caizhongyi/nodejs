<!DOCTYPE html>
<html lang="zh_CN">
<head>
  <meta charset="utf-8" />
  <title>addons - Node.js Manual &amp; Documentation</title>
  <link rel="stylesheet" href="res/style.css" tppabs="http://cnodejs.org/cman/res/style.css" type="text/css" media="all" />
  <link rel="stylesheet" href="res/sh.css" tppabs="http://cnodejs.org/cman/res/sh.css" type="text/css" media="all"/>
</head>
<body>
  <div id="container">
    <header>
      <h1>Node.js Manual &amp; Documentation</h1>
      <div id="gtoc">
        <p><a href="index.html" tppabs="http://cnodejs.org/cman/index.html">Index</a> | <a href="all.html" tppabs="http://cnodejs.org/cman/all.html">View on single page</a></p>
      </div>
      <hr />
    </header>
    <div id="toc"><h2>Table Of Contents</h2><ul><li><a href="#addons_">Addons  æ‰©å±•æ’ä»¶</a></li></ul><hr /></div>
<h2 id="addons_">Addons  æ‰©å±•æ’ä»¶</h2>

<p>Addons are dynamically linked shared objects. They can provide glue to C and
C++ libraries. The API (at the moment) is rather complex, involving
knowledge of several libraries:</p>

<p>æ‰©å±•æ’ä»¶ï¼ˆAddonsï¼‰æ˜¯åŠ¨æ€é“¾æ¥çš„å…±äº«å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡æä¾›äº†ä½¿ç”¨C/C++ç±»åº“çš„èƒ½åŠ›ã€‚ç”±äºæ¶‰åŠäº†å¤šä¸ªç±»åº“å¯¼è‡´äº†è¿™ç±»APIç›®å‰æ¯”è¾ƒç¹æ‚ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹è¿°å‡ ä¸ªä¸»è¦ç±»åº“ï¼š</p>

<ul><li><p>V8 JavaScript, a C++ library. Used for interfacing with JavaScript:
creating objects, calling functions, etc.  Documented mostly in the
<code>v8.h</code> header file (<code>deps/v8/include/v8.h</code> in the Node source tree).</p><p>V8 JavaScriptï¼ŒC++ç±»åº“ï¼Œä½œä¸ºJavaScriptçš„æ¥å£ç±»ï¼Œä¸»è¦ç”¨äºåˆ›å»ºå¯¹è±¡ã€è°ƒç”¨æ–¹æ³•ç­‰åŠŸèƒ½ã€‚å¤§éƒ¨åˆ†åŠŸèƒ½åœ¨å¤´æ–‡ä»¶<code>v8.h</code> ï¼ˆåœ¨nodeæ–‡ä»¶å¤¹ä¸‹çš„è·¯å¾„ä¸º<code>deps/v8/include/v8.h</code>ï¼‰ä¸­æœ‰è¯¦ç»†æ–‡æ¡£ã€‚</p></li><li><p>libev, C event loop library. Anytime one needs to wait for a file
descriptor to become readable, wait for a timer, or wait for a signal to
received one will need to interface with libev.  That is, if you perform
any I/O, libev will need to be used.  Node uses the <code>EV_DEFAULT</code> event
loop.  Documentation can be found <a href="javascript:if(confirm('http://cvs.schmorp.de/libev/ev.html  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://cvs.schmorp.de/libev/ev.html'" tppabs="http://cvs.schmorp.de/libev/ev.html">here</a>.</p><p>libevï¼ŒåŸºäºCçš„äº‹ä»¶å¾ªç¯åº“ã€‚å½“éœ€è¦ç­‰å¾…æ–‡ä»¶æè¿°ï¼ˆfile descriptorï¼‰ä¸ºå¯è¯»æ—¶ï¼Œç­‰å¾…å®šæ—¶å™¨æ—¶ï¼Œæˆ–è€…ç­‰å¾…æ¥å—ä¿¡å·æ—¶ï¼Œä¼šéœ€è¦è°ƒç”¨libevåº“ã€‚ä¹Ÿå¯ä»¥è¯´ï¼Œä»»ä½•IOæ“ä½œéƒ½éœ€è¦è°ƒç”¨libevåº“ã€‚Nodeä½¿ç”¨<code>EV_DEFAULT</code>äº‹ä»¶å¾ªç¯æœºåˆ¶ã€‚åœ¨<a href="javascript:if(confirm('http://cvs.schmorp.de/libev/ev.html  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://cvs.schmorp.de/libev/ev.html'" tppabs="http://cvs.schmorp.de/libev/ev.html">è¿™é‡Œ</a>å¯ä»¥æŸ¥é˜…ç›¸å…³æ–‡æ¡£ã€‚</p></li><li><p>libeio, C thread pool library. Used to execute blocking POSIX system
calls asynchronously. Mostly wrappers already exist for such calls, in
<code>src/file.cc</code> so you will probably not need to use it. If you do need it,
look at the header file <code>deps/libeio/eio.h</code>.</p><p>libeioï¼ŒåŸºäºCçš„çº¿ç¨‹æ± åº“ï¼Œç”¨äºä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œé˜»å¡å¼POSIXç³»ç»Ÿè°ƒç”¨ã€‚å› ä¸ºå¤§éƒ¨åˆ†è¿™ç±»è°ƒç”¨éƒ½åœ¨<code>src/file.cc</code>ä¸­è¢«å°è£…äº†ï¼Œä½ ä¸€èˆ¬ä¸éœ€è¦ç›´æ¥ä½¿ç”¨libeioã€‚å¦‚æœå¿…é¡»ä½¿ç”¨è¯¥ç±»åº“æ—¶ï¼Œå¯æŸ¥çœ‹å…¶å¤´æ–‡ä»¶<code>deps/libeio/eio.h</code>ã€‚</p></li><li><p>Internal Node libraries. Most importantly is the <code>node::ObjectWrap</code>
class which you will likely want to derive from.</p><p>å†…éƒ¨Nodeåº“ã€‚åœ¨è¯¥åº“ä¸­ï¼Œæœ€é‡è¦çš„ç±»æ˜¯æˆ‘ä»¬å¯èƒ½ç”¨äºè¿›è¡Œæ´¾ç”Ÿçš„<code>node::ObjectWrap</code>åŸºç±»ã€‚</p></li><li><p>Others. Look in <code>deps/</code> for what else is available.</p><p>å…¶ä»–çš„ä¸€äº›ç±»åº“åŒæ ·å¯ä»¥åœ¨<code>deps/</code> ä¸­æ‰¾åˆ°ã€‚</p></li></ul>

<p>Node statically compiles all its dependencies into the executable. When
compiling your module, you don't need to worry about linking to any of these
libraries.</p>

<p>Nodeå·²å°†æ‰€æœ‰ä¾èµ–å…³ç³»é™æ€åœ°ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç¼–è¯‘è‡ªå·±çš„ç»„ä»¶æ—¶ä¸éœ€è¦æ‹…å¿ƒå’Œè¿™äº›ç±»åº“çš„é“¾æ¥é—®é¢˜ã€‚</p>

<p>To get started let's make a small Addon which does the following except in
C++:</p>

<p>è®©æˆ‘ä»¬ç€æ‰‹ç¼–å†™ä¸€ä¸ªAddonçš„å°ä¾‹å­ï¼Œæ¥è¾¾åˆ°å¦‚ä¸‹æ¨¡å—åŒæ ·çš„æ•ˆæœï¼š</p>

<pre><code>exports.hello = 'world';</code></pre>

<p>To get started we create a file <code>hello.cc</code>:</p>

<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code>hello.cc</code>æ–‡ä»¶ï¼š</p>

<pre><code>#include &lt;v8.h&gt;

using namespace v8;

extern "C" void
init (Handle&lt;Object&gt; target)
{
  HandleScope scope;
  target-&gt;Set(String::New("hello"), String::New("world"));
}</code></pre>

<p>This source code needs to be built into <code>hello.node</code>, the binary Addon. To
do this we create a file called <code>wscript</code> which is python code and looks
like this:</p>

<p>è¿™äº›æºç ä¼šç¼–è¯‘æˆä¸€ä¸ªäºŒè¿›åˆ¶çš„Addonæ–‡ä»¶<code>hello.node</code>ã€‚ä¸ºæ­¤æˆ‘ä»¬ç”¨pythonç¼–å†™å¦‚ä¸‹çš„åä¸º<code>wscript</code>çš„æ–‡ä»¶ï¼š</p>

<pre><code>srcdir = '.'
blddir = 'build'
VERSION = '0.0.1'

def set_options(opt):
  opt.tool_options('compiler_cxx')

def configure(conf):
  conf.check_tool('compiler_cxx')
  conf.check_tool('node_addon')

def build(bld):
  obj = bld.new_task_gen('cxx', 'shlib', 'node_addon')
  obj.target = 'hello'
  obj.source = 'hello.cc'</code></pre>

<p>Running <code>node-waf configure build</code> will create a file
<code>build/default/hello.node</code> which is our Addon.</p>

<p>è¿è¡Œ<code>node-waf configure build</code>ï¼Œæˆ‘ä»¬å°±åˆ›å»ºäº†ä¸€ä¸ªAddonå®ä¾‹<code>build/default/hello.node</code>ã€‚</p>

<p><code>node-waf</code> is just <a href="javascript:if(confirm('http://code.google.com/p/waf  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://code.google.com/p/waf'" tppabs="http://code.google.com/p/waf">WAF</a>, the python-based build system. <code>node-waf</code> is
provided for the ease of users.</p>

<p><code>node-waf</code>å°±æ˜¯<a href="javascript:if(confirm('http://code.google.com/p/waf  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://code.google.com/p/waf'" tppabs="http://code.google.com/p/waf">WAF</a>,ï¼Œä¸€ç§åŸºäºpythonçš„ç¼–è¯‘ç³»ç»Ÿï¼Œè€Œ<code>node-waf</code>æ›´åŠ æ˜“äºä½¿ç”¨ã€‚</p>

<p>All Node addons must export a function called <code>init</code> with this signature:</p>

<p>å¦å¤–ï¼Œåœ¨Nodeä¸­ä»»ä½•çš„Addonå¿…é¡»ä½¿ç”¨è¾“å‡ºä¸€ä¸ªå¦‚ä¸‹å£°æ˜çš„<code>init</code>å‡½æ•°ï¼š</p>

<pre><code>extern 'C' void init (Handle&lt;Object&gt; target)</code></pre>

<p>For the moment, that is all the documentation on addons. Please see
<a href="javascript:if(confirm('http://github.com/ry/node_postgres  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://github.com/ry/node_postgres'" tppabs="http://github.com/ry/node_postgres">http://github.com/ry/node_postgres</a> for a real example.</p>

<p>ç›®å‰å…³äºaddonçš„æ‰€æœ‰æ–‡æ¡£å°±æ˜¯è¿™äº›ã€‚å¦å¤–ï¼Œåœ¨<a href="javascript:if(confirm('http://github.com/ry/node_postgres  \n\n¸ÃÎÄ¼şÎŞ·¨ÓÃ Teleport Ultra ÏÂÔØ, ÒòÎª ËüÊÇÒ»¸öÓò»òÂ·¾¶Íâ²¿±»ÉèÖÃÎªËüµÄÆôÊ¼µØÖ·µÄµØÖ·¡£  \n\nÄãÏëÔÚ·şÎñÆ÷ÉÏ´ò¿ªËü?'))window.location='http://github.com/ry/node_postgres'" tppabs="http://github.com/ry/node_postgres">http://github.com/ry/node_postgres</a>ä¸­è¿˜æä¾›äº†ä¸€ä¸ªAddonçš„å®ä¾‹ã€‚</p>
  </div>
  <script type="text/javascript" src="res/sh_main.js" tppabs="http://cnodejs.org/cman/res/sh_main.js"></script>
  <script type="text/javascript" src="res/sh_javascript.min.js" tppabs="http://cnodejs.org/cman/res/sh_javascript.min.js"></script>
  <script type="text/javascript">highlight(undefined, undefined, 'pre');</script>
</body>
</html>
